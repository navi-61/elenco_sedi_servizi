<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Filtro Sedi da CSV Esterno</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: white;
      color: #333;
      padding: 20px;
    }
	select {
      font-size: 14px;
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
	}
    .dark-mode {
      background: #121212;
      color: #eee;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
	  font-size: 14px;
      padding: 6px 10px;
      border: 1px solid #ccc;
      text-align: left;
    }

    th {
      cursor: pointer;
      background-color: #f2f2f2;
    }

    .tooltip {
      position: relative;
      display: inline-block;
      cursor: help;
    }

    .tooltip .tooltiptext {
      visibility: hidden;
      width: max-content;
      max-width: 300px;
      background-color: #fff8c4; /* giallo chiaro */
      color: #333;
      text-align: left;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
      position: absolute;
      z-index: 1;
      top: 100%;
      left: 0;
      white-space: normal;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }

    button, select {
	  font-size: 12px;
      padding: 8px;
    }

    .pagination {
      margin-top: 10px;
    }

    .pagination button {
      margin-right: 5px;
      padding: 5px 10px;
    }
  </style>
</head>
<body>
  <h2>ELENCO SEDI</h2>

  <div class="controls">
    <select id="cityFilter">
      <option value="">-- Tutte le CittÃ  --</option>
    </select>

    <select id="serviceFilter">
      <option value="">-- Tutti i Servizi --</option>
    </select>

    <select id="presidioFilter">
      <option value="">-- Tutti i Presidi --</option>
    </select>

    <button onclick="resetFilters()">ðŸ”„ Reset filtri</button>
    <button onclick="exportPDF()">ðŸ“„ Esporta PDF</button>
    <button onclick="toggleDarkMode()">ðŸŒ“ Tema chiaro/scuro</button>
  </div>

  <table id="dataTable">
    <thead>
      <tr>
        <th onclick="sortTable(0)">CittÃ </th>
        <th onclick="sortTable(1)">Indirizzo</th>
        <th onclick="sortTable(2)">Servizio ASST</th>
        <th onclick="sortTable(3)">Email</th>
        <th onclick="sortTable(4)">Presidio Fleet</th>
        <th onclick="sortTable(5)">Note</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="pagination" id="pagination"></div>

  <script>
    let rows = [];
    const pageSize = 20;
    let currentPage = 1;
    let sortAsc = true;
    let currentSortIndex = null;

    const tbody = document.querySelector('tbody');
    const pagination = document.getElementById('pagination');

    // Tooltip email per presidio (chiave maiuscola)
    const tooltipEmails = {
      'CARATE': 'sia.carate@asst-brianza.it',
      'VIMERCATE': 'sia.vimercate@asst-brianza.it',
      'DESIO': 'sia.desio@asst-brianza.it',
      'IRCCS MONZA': 'sia.monza@asst-brianza.it',
    };

    // Funzione per caricare e parsare CSV
    async function loadCSV() {
      try {
        const response = await fetch('dati.csv');
        if(!response.ok) throw new Error('Errore caricamento CSV: ' + response.statusText);

        const text = await response.text();
        parseCSV(text);
        populateFilters();
        renderTable();
      } catch(err) {
        alert(err.message);
      }
    }

    // Parse CSV semplice (assume header e ; come separatore)
    function parseCSV(text) {
      const lines = text.trim().split('\n');
      const headers = lines[0].split(';').map(h => h.trim());
      rows = lines.slice(1).map(line => {
        const values = line.split(';').map(v => v.trim());
        return {
          citta: values[0] || '',
          indirizzo: values[1] || '',
          servizio: values[2] || '',
          email: values[3] || '',
          presidio: values[4] || '',
          note: values[5] || ''
        };
      });
    }

    function populateFilters() {
      const cityFilter = document.getElementById('cityFilter');
      const serviceFilter = document.getElementById('serviceFilter');
      const presidioFilter = document.getElementById('presidioFilter');

      // Pulisce opzioni esistenti tranne la prima (default)
      cityFilter.options.length = 1;
      serviceFilter.options.length = 1;
      presidioFilter.options.length = 1;

      const cities = Array.from(new Set(rows.map(r => r.citta))).sort();
      const services = Array.from(new Set(rows.map(r => r.servizio))).sort();
      const presidi = Array.from(new Set(rows.map(r => r.presidio))).sort();

      for (const city of cities) {
        if(city) {
          const option = document.createElement('option');
          option.value = city;
          option.textContent = city;
          cityFilter.appendChild(option);
        }
      }
      for (const serv of services) {
        if(serv) {
          const option = document.createElement('option');
          option.value = serv;
          option.textContent = serv;
          serviceFilter.appendChild(option);
        }
      }
      for (const pres of presidi) {
        if(pres) {
          const option = document.createElement('option');
          option.value = pres;
          option.textContent = pres;
          presidioFilter.appendChild(option);
        }
      }
    }

    function filterRows() {
      const cityVal = document.getElementById('cityFilter').value;
      const serviceVal = document.getElementById('serviceFilter').value;
      const presidioVal = document.getElementById('presidioFilter').value;

      return rows.filter(row => {
        return (!cityVal || row.citta === cityVal) &&
               (!serviceVal || row.servizio === serviceVal) &&
               (!presidioVal || row.presidio === presidioVal);
      });
    }

    function renderTable() {
      const filtered = filterRows();

      if (currentSortIndex !== null) {
        filtered.sort((a, b) => {
          let valA, valB;
          switch(currentSortIndex) {
            case 0: valA = a.citta.toLowerCase(); valB = b.citta.toLowerCase(); break;
            case 1: valA = a.indirizzo.toLowerCase(); valB = b.indirizzo.toLowerCase(); break;
            case 2: valA = a.servizio.toLowerCase(); valB = b.servizio.toLowerCase(); break;
            case 3: valA = a.email.toLowerCase(); valB = b.email.toLowerCase(); break;
            case 4: valA = a.presidio.toLowerCase(); valB = b.presidio.toLowerCase(); break;
            case 5: valA = a.note.toLowerCase(); valB = b.note.toLowerCase(); break;
            default: valA = ''; valB = '';
          }
          if(valA < valB) return sortAsc ? -1 : 1;
          if(valA > valB) return sortAsc ? 1 : -1;
          return 0;
        });
      }

      const totalPages = Math.ceil(filtered.length / pageSize);
      if(currentPage > totalPages) currentPage = totalPages || 1;

      const pageRows = filtered.slice((currentPage -1)*pageSize, currentPage*pageSize);

      tbody.innerHTML = '';
      for (const row of pageRows) {
        const presidioUpper = row.presidio.toUpperCase();
        const tooltipEmail = tooltipEmails[presidioUpper] || '';

        const emailRaw = row.email.trim();
        let emailCell = '';

        if(emailRaw.includes('@')) {
          // email valida, la mostro semplice senza tooltip
          emailCell = `${emailRaw}`;
        } else if(emailRaw === '' && tooltipEmail) {
          // campo email vuoto ma presidio noto
          emailCell = `
            <div class="tooltip">${row.presidio}
              <span class="tooltiptext">${tooltipEmail}</span>
            </div>`;
        } else if(tooltipEmails[emailRaw.toUpperCase()]) {
          // campo email contiene presidio, mostro con tooltip
          emailCell = `
            <div class="tooltip">${emailRaw}
              <span class="tooltiptext">${tooltipEmails[emailRaw.toUpperCase()]}</span>
            </div>`;
        } else {
          // altrimenti mostro testo semplice
          emailCell = emailRaw;
        }

        tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.citta}</td>
          <td>${row.indirizzo}</td>
          <td>
            <div class="tooltip">${row.servizio || ''}
              <span class="tooltiptext">${row.servizio || ''}</span>
            </div>
          </td>
          <td>${emailCell}</td>
          <td>${row.presidio}</td>
          <td>
            <div class="tooltip">${row.note || ''}
              <span class="tooltiptext">${row.note || ''}</span>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      }

      renderPagination(totalPages);
    }

    function renderPagination(totalPages) {
      pagination.innerHTML = '';

      if(totalPages <= 1) return;

      for(let i=1; i <= totalPages; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        if(i === currentPage) btn.disabled = true;
        btn.addEventListener('click', () => {
          currentPage = i;
          renderTable();
        });
        pagination.appendChild(btn);
      }
    }

    function resetFilters() {
      document.getElementById('cityFilter').value = '';
      document.getElementById('serviceFilter').value = '';
      document.getElementById('presidioFilter').value = '';
      currentPage = 1;
      currentSortIndex = null;
      sortAsc = true;
      renderTable();
    }

    function sortTable(index) {
      if(currentSortIndex === index) {
        sortAsc = !sortAsc;
      } else {
        currentSortIndex = index;
        sortAsc = true;
      }
      renderTable();
    }

    function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const filtered = filterRows();
      const headers = ["CittÃ ", "Indirizzo", "Servizio ASST", "Email", "Presidio Fleet", "Note"];
      const data = filtered.map(row => [row.citta, row.indirizzo, row.servizio, row.email, row.presidio, row.note]);

      doc.setFontSize(12);
      doc.text("Esportazione Sedi Filtrate", 10, 10);

      // Usa autoTable per la tabella (controlla se plugin caricato correttamente)
      doc.autoTable({
        startY: 20,
        head: [headers],
        body: data,
        styles: { fontSize: 8 }
      });

      doc.save("Sedi_Filtrate.pdf");
    }

    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
    }

    // Event listeners filtri
    document.getElementById('cityFilter').addEventListener('change', () => { currentPage = 1; renderTable(); });
    document.getElementById('serviceFilter').addEventListener('change', () => { currentPage = 1; renderTable(); });
    document.getElementById('presidioFilter').addEventListener('change', () => { currentPage = 1; renderTable(); });

    // Carica CSV al caricamento pagina
    loadCSV();

  </script>
  <!-- Tabella in PDF richiede autoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</body>
</html>
